#!/bin/bash

# 오프라인 설치를 위한 apt 패키지 복원 스크립트

echo "=== APT 패키지 오프라인 복원 스크립트 ==="

# 백업 파일 찾기
BACKUP_FILE=$(ls apt-backup-*.tar.gz 2>/dev/null | head -n 1)

if [ -z "$BACKUP_FILE" ]; then
    echo "❌ 백업 파일(apt-backup-*.tar.gz)을 찾을 수 없습니다."
    echo "현재 디렉토리에 백업 파일이 있는지 확인하세요."
    exit 1
fi

echo "백업 파일 발견: $BACKUP_FILE"

# 압축 해제
echo -e "\n[1/4] 백업 파일 압축 해제 중..."
tar -xzf "$BACKUP_FILE"
BACKUP_DIR=$(basename "$BACKUP_FILE" .tar.gz)
echo "✓ 압축 해제 완료: $BACKUP_DIR"

# .deb 파일 개수 확인
PACKAGE_COUNT=$(ls "$BACKUP_DIR/packages"/*.deb 2>/dev/null | wc -l)
echo "발견된 패키지: $PACKAGE_COUNT 개"

# 로컬 저장소 생성
echo -e "\n[2/4] 로컬 APT 저장소 생성 중..."
LOCAL_REPO="/var/local-apt-repo"
sudo mkdir -p "$LOCAL_REPO"
sudo cp "$BACKUP_DIR/packages"/*.deb "$LOCAL_REPO/" 2>/dev/null

# Packages 인덱스 생성
cd "$LOCAL_REPO"
sudo dpkg-scanpackages . /dev/null | sudo tee Packages > /dev/null
sudo gzip -c Packages | sudo tee Packages.gz > /dev/null
cd - > /dev/null

echo "✓ 로컬 저장소 생성 완료: $LOCAL_REPO"

# sources.list에 로컬 저장소 추가
echo -e "\n[3/4] 로컬 저장소를 APT에 추가 중..."
echo "deb [trusted=yes] file://$LOCAL_REPO ./" | sudo tee /etc/apt/sources.list.d/local-repo.list
sudo apt-get update
echo "✓ 로컬 저장소 추가 완료"

# 패키지 설치
echo -e "\n[4/4] 패키지 설치 중..."
echo "방법을 선택하세요:"
echo "1) apt-clone으로 복원 (추천)"
echo "2) dpkg로 직접 설치"
echo "3) 패키지 목록으로 설치"
read -p "선택 (1-3): " choice

case $choice in
    1)
        if [ -f "$BACKUP_DIR/apt-clone-backup.tar.gz" ]; then
            if command -v apt-clone &> /dev/null; then
                sudo apt-clone restore "$BACKUP_DIR/apt-clone-backup.tar.gz"
                echo "✓ apt-clone 복원 완료"
            else
                echo "❌ apt-clone이 설치되지 않았습니다."
                echo "먼저 로컬 저장소에서 설치: sudo apt-get install apt-clone"
            fi
        else
            echo "❌ apt-clone 백업 파일을 찾을 수 없습니다."
        fi
        ;;
    2)
        echo "dpkg로 직접 설치 중..."
        sudo dpkg -i "$BACKUP_DIR/packages"/*.deb
        sudo apt-get install -f -y  # 의존성 해결
        echo "✓ 설치 완료"
        ;;
    3)
        if [ -f "$BACKUP_DIR/lists/package-selections.txt" ]; then
            sudo dpkg --set-selections < "$BACKUP_DIR/lists/package-selections.txt"
            sudo apt-get dselect-upgrade -y
            echo "✓ 설치 완료"
        else
            echo "❌ 패키지 목록 파일을 찾을 수 없습니다."
        fi
        ;;
    *)
        echo "잘못된 선택입니다."
        exit 1
        ;;
esac

echo -e "\n=== 복원 완료 ==="
echo "설치된 패키지를 확인하려면: dpkg -l"
echo "로컬 저장소를 제거하려면: sudo rm /etc/apt/sources.list.d/local-repo.list"